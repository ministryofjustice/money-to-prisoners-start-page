# PARTLY generated by https://github.com/ministryofjustice/money-to-prisoners-deploy
version: 2.1
jobs:
  build-test-push:
    docker:
      - image: ${ECR_ENDPOINT}/prisoner-money/money-to-prisoners:deploy-tools
    environment:
      app: start-page
    working_directory: /tmp/repo
    steps:
      - checkout
      - run:
          name: Inspect tags
          command: |
            CIRCLE_BRANCH_LOWERCASE=$(echo $CIRCLE_BRANCH | tr '[:upper:]' '[:lower:]')

            registry=${ECR_ENDPOINT}/prisoner-money/money-to-prisoners
            version=${CIRCLE_BRANCH_LOWERCASE}.${CIRCLE_SHA1:0:7}
            tag=${app}.${version}

            echo export CIRCLE_BRANCH_LOWERCASE=${CIRCLE_BRANCH_LOWERCASE} > /tmp/mtp-env.sh
            echo export registry=${registry} >> /tmp/mtp-env.sh
            echo export version=${version} >> /tmp/mtp-env.sh
            echo export tag=${tag} >> /tmp/mtp-env.sh

            echo "Building ${tag}"
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Test code
          command: |
            source /tmp/mtp-env.sh
            pip3 install -r requirements-tests.txt
            flake8
      - restore_cache:
          name: Restoring docker cache
          keys:
            - docker-v1-{{ checksum "Dockerfile" }}
          paths:
            - /tmp/docker-cache.tar
      - run:
          name: Load docker cache
          command: |
            source /tmp/mtp-env.sh
            [[ -f /tmp/docker-cache.tar ]] && docker load -i /tmp/docker-cache.tar || true
      - run:
          name: Log into ECR
          command: |
            source /tmp/mtp-env.sh
            aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ECR_ENDPOINT}
      - run:
          name: Build docker image
          command: |
            source /tmp/mtp-env.sh
            docker build \
              --pull --force-rm \
              --cache-from=${app} \
              --build-arg APP_GIT_COMMIT=${CIRCLE_SHA1} \
              --build-arg APP_GIT_BRANCH=${CIRCLE_BRANCH} \
              --build-arg APP_BUILD_TAG=${tag} \
              --build-arg APP_BUILD_DATE=$(date +%FT%T%z) \
              --tag ${tag} --tag ${app} \
              .
      - run:
          name: Dumping docker cache
          command: |
            source /tmp/mtp-env.sh
            docker save -o /tmp/docker-cache.tar ${app}
      - save_cache:
          name: Saving docker cache
          key: docker-v1-{{ checksum "Dockerfile" }}
          paths:
            - /tmp/docker-cache.tar
      - run:
          name: Push docker image
          command: |
            source /tmp/mtp-env.sh
            echo "Pushing ${tag} to ECR"
            docker tag ${tag} ${registry}:${tag}
            docker push ${registry}:${tag}
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              echo "Pushing ${app} to ECR (acts as latest)"
              docker tag ${tag} ${registry}:${app}
              docker push ${registry}:${app}
            fi
      - run:
          name: Log out of ECR
          command: |
            source /tmp/mtp-env.sh
            docker logout ${ECR_ENDPOINT}
      - deploy:
          name: Deploy to test
          command: |
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              source /tmp/mtp-env.sh
              echo "Deploying to test"

              echo -n ${K8S_CLUSTER_CERT} | base64 -d > /tmp/mtp-k8s-ca.crt
              kubectl config set-cluster ${K8S_CLUSTER_NAME} --certificate-authority=/tmp/mtp-k8s-ca.crt --server=${K8S_CLUSTER_SERVER}
              kubectl config set-credentials circleci --token=${K8S_TOKEN}
              kubectl config set-context ${K8S_CLUSTER_NAME} --cluster=${K8S_CLUSTER_NAME} --user=circleci --namespace=${K8S_NAMESPACE}
              kubectl config use-context ${K8S_CLUSTER_NAME}
              IMAGE=${registry}:${tag}
              kubectl patch configmap app-versions --patch "{\"data\": {\"${app}\": \"${version}\"}}"
              kubectl patch deployment ${app} --type strategic --patch "{\"metadata\": {\"annotations\": {\"kubernetes.io/change-cause\": \"${version}\"}}, \"spec\": {\"template\": {\"spec\": {\"containers\": [{\"name\": \"app\", \"image\": \"${IMAGE}\"}], \"initContainers\": [{\"name\": \"copy-static\", \"image\": \"${IMAGE}\"}]}}}}"
            else
              echo "Not deploying to test"
            fi
      - run:
          name: Clean up ECR
          command: |
            source /tmp/mtp-env.sh
            echo "Cleaning ECR"

            delete_images() {
              if [[ "${IMAGES_TO_DELETE}" ]]; then
                AWS_ECR_ARGS=
                for IMAGE_TO_DELETE in ${IMAGES_TO_DELETE}; do
                  AWS_ECR_ARGS="${AWS_ECR_ARGS} imageDigest=${IMAGE_TO_DELETE}"
                done
                aws ecr batch-delete-image --repository-name prisoner-money/money-to-prisoners --image-ids ${AWS_ECR_ARGS}
              fi
            }

            echo "Deleting untagged images"
            IMAGES_TO_DELETE=$(aws ecr list-images --repository-name prisoner-money/money-to-prisoners --filter tagStatus=UNTAGGED --query 'imageIds[*].imageDigest' --output text)
            delete_images

            if [[ "${CIRCLE_BRANCH}" != "main" ]]; then
              echo "Deleting other images from branch ${CIRCLE_BRANCH}"
              IMAGES_TO_DELETE=$(aws ecr describe-images --repository-name prisoner-money/money-to-prisoners --query 'imageDetails[?contains(map(&starts_with(@, '"'"${app}.${CIRCLE_BRANCH_LOWERCASE}."'"'), @.imageTags), `true`) && ! contains(@.imageTags, '"'"${tag}"'"')].imageDigest' --output text)
              delete_images
            fi
workflows:
  version: 2
  build-test-push:
    jobs:
      - build-test-push
